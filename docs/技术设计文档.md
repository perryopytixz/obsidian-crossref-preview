# Obsidian Crossref Preview 技术设计文档

## 1. 背景与目标

本插件用于在 Obsidian 中实现 Quarto 风格交叉引用的预览能力，满足以下需求：

- 不修改原始 Markdown（preview-only）
- 支持公式、图片、定理类块的自动编号
- 支持 `@label` 引用渲染与点击跳转
- 缺失引用可视化提示
- 编辑流程中继续保持原始写作语法，便于直接迁移到 `.qmd`
- 在编辑模式（Live Preview）提供标签高亮与补全提示

该插件定位为 **写作阶段增强层**，而非 Quarto/Pandoc 的替代品。

## 2. 范围定义

### 2.1 当前实现范围（MVP）

- 公式标签：`{#eq-*}`
- 图片标签：`{#fig-*}`
- 定理类标签：`{#thm-*}`、`{#lem-*}`、`{#cor-*}`、`{#prp-*}`、`{#cnj-*}`、`{#def-*}`、`{#exm-*}`、`{#exr-*}`、`{#sol-*}`、`{#rem-*}`、`{#alg-*}`
- 引用语法：`@<label>`
- 引用跳转：同一文件内锚点跳转
- 缺失引用：保留原引用文本并附加 `.crossref-ref-missing` 样式

### 2.2 非目标

- 不做跨文件引用
- 不写回/重排 Markdown 源文件
- 不承诺与 Quarto 输出编号完全一致（导出仍以 Quarto 为准）

## 3. 总体架构

插件由四部分组成：

1. **源码解析器（Index Parser）**
   - 输入：当前 Markdown 文本
   - 输出：标签索引（类型、编号、行号、显示文案）
2. **渲染后处理器（Post Processor）**
   - 在 Obsidian 的 Markdown 渲染阶段工作
   - 基于标签索引进行目标标注、编号显示、引用替换
3. **交互层（Interaction Layer）**
   - 监听引用链接点击事件，执行平滑滚动与目标高亮
4. **编辑增强层（Editor Enhancer）**
   - 为 `@label` 与 `{#label}` 提供语法高亮
   - 提供引用与标签前缀自动补全
5. **样式层（CSS）**
   - 定义编号、缺失引用、定理块等可视化样式

对应文件：

- `main.js`：逻辑入口与实现
- `styles.css`：样式定义
- `manifest.json`：插件元信息
- `versions.json`：兼容版本映射

## 4. 数据模型

### 4.1 标签描述符（Descriptor）

每个可引用目标在解析后转成统一结构：

- `label`: 标签名，例如 `eq-einstein`
- `kind`: `equation | figure | theorem`
- `prefix`: 标签前缀（如 `eq`、`fig`、`thm`）
- `number`: 对应类型下的顺序编号（从 1 开始）
- `lineStart` / `lineEnd`: 在源文件中的行区间
- `title`: 定理块可选标题

### 4.2 索引结构（Index）

- `labels: Map<string, Descriptor>`：label 到描述符的映射
- `orderedTargets: Descriptor[]`：按行号排序的目标列表

## 5. 核心流程

### 5.1 文本读取

优先策略：

1. 若当前文件处于活动 Markdown 视图，优先读取编辑器文本（包含未保存修改）
2. 否则回退到 `cachedRead` 读取文件内容

这样可以尽量保证预览与当前编辑状态一致。

### 5.2 索引解析

解析器通过正则扫描源码并生成索引：

- 公式块：`\$\$ ... \$\$ {#eq-...}`
- 图片：`![...](...){#fig-...}`
- 定理块：`::: {#thm-...} ... :::`

编号规则：

- 公式全局计数（当前文件内）
- 图片全局计数（当前文件内）
- 定理类按前缀分别计数（如 `thm` 与 `lem` 各自从 1 计）

### 5.3 渲染后处理

对每个渲染 section 执行：

1. 基于行区间筛出当前 section 涉及的目标
2. 清理标签文本（如 `{#eq-x}`）在预览中的可见残留
3. 对目标元素注入编号和锚点
4. 将 `@label` 替换为可点击引用
5. 对缺失 label 引用附加缺失样式
6. 清理可能出现的空段落

### 5.4 点击跳转

点击 `.crossref-ref` 时：

- 解析链接中的 label
- 在当前视图定位锚点元素
- 平滑滚动到目标
- 临时添加闪烁高亮类，增强定位反馈

## 6. 定理块渲染策略

当 section 文本匹配完整定理 fenced block 时，插件将其转换为结构化容器：

- 容器：`.crossref-theorem`
- 标题：`.crossref-theorem-title`（如 `Theorem 1. Title`）
- 正文：`.crossref-theorem-body`

正文仍通过 Obsidian 的 `MarkdownRenderer` 渲染，保留 Markdown 能力。

## 7. 性能与缓存

### 7.1 缓存策略

- 以 `sourcePath` 为 key 缓存索引
- 使用源文本哈希判断缓存是否可复用
- 在文件修改/重命名/删除与编辑事件中失效缓存

### 7.2 复杂度

- 索引解析：`O(n)`（n 为文本长度）
- section 渲染：与 section DOM 大小线性相关

MVP 范围内可满足普通文档实时写作需求。

## 8. 兼容性与限制

### 8.1 兼容性

- 目标 Obsidian 最低版本：`1.5.0`
- 插件形态：纯 JS（无需构建步骤即可安装测试）
- 数学公式写法按 Obsidian 原生规则：行内 `$...$`，行间 `$$...$$`

### 8.2 已知限制

- 当前仅支持单文件内引用
- 正则解析策略未覆盖所有复杂嵌套/转义场景
- 定理块渲染以常见写法为主，极端混排段落可能需要后续增强

## 9. 验收建议

建议使用以下检查维度：

1. **功能正确性**
   - 公式/图片/定理编号是否按预期递增
   - `@label` 是否替换为正确文案
2. **交互正确性**
   - 点击引用是否跳转且高亮目标
   - 缺失引用是否显示为缺失样式
3. **稳定性**
   - 编辑时不改写源文件
   - 多次切换阅读/编辑模式无重复渲染或明显闪烁

## 10. 后续迭代方向

- 跨文件引用（按 `path#label`）
- 设置面板（编号格式、定理命名本地化、是否开启平滑滚动）
- 更强的语法解析（减少正则局限）
- 与 Quarto/Pandoc 规则更高一致性的编号策略
